; ╔══════════════════════════════════════════════════════════════════╗
; ║  MohnSters Unified Firmware — Multi-Device Build System        ║
; ║  One codebase → many device tiers                              ║
; ║                                                                ║
; ║  Every device is a "container" (HUD tier). The creature's       ║
; ║  size, animation quality, and capabilities are determined      ║
; ║  by the hardware it lives inside.                              ║
; ║                                                                ║
; ║  Devices (smallest → largest):                                 ║
; ║    xiao_c6   — No screen, phone-only view (Nano Pod)           ║
; ║    hiletgo   — No screen, LED heartbeat (Micro Pod)            ║
; ║    tracker   — 80×160 TFT, LoRa, GPS (Small Tank)             ║
; ║    vmt190    — 170×320 TFT, PSRAM (Wrist HUD) ← TESTED        ║
; ╠══════════════════════════════════════════════════════════════════╣
; ║  Build:  pio run -e vmt190                                     ║
; ║  Upload: pio run -e vmt190 -t upload                           ║
; ║  All:    pio run                                               ║
; ╚══════════════════════════════════════════════════════════════════╝

; ──────────────────────────────────────────────
;  SHARED DEFAULTS (all devices inherit this)
; ──────────────────────────────────────────────
[env]
framework = arduino
monitor_speed = 115200

lib_deps =
    bblanchon/ArduinoJson@^7.0.0

build_flags =
    ; ── Firmware Identity ──
    -DFIRMWARE_VERSION="\"2.0.0\""
    -DMOHN_NODE_TYPE="\"MohnNode\""

    ; ── API (cloud + local desktop fallback) ──
    -DAPI_CLOUD_URL="\"https://us-central1-mohnsters.cloudfunctions.net\""
    -DAPI_LOCAL_HOST="\"172.22.56.218\""
    -DAPI_LOCAL_PORT=3847
    -DAPI_USE_LOCAL=1
    -DAPI_PATH_HEARTBEAT=\"/heartbeat\"
    -DAPI_PATH_REGISTER="\"/api/node/register\""
    -DAPI_PATH_ARENA="\"/api/node/arena-tick\""
    -DAPI_PATH_EGG="\"/api/node/generate-egg\""

    ; ── Provisioning ──
    -DAP_SSID="\"MohnNode-Setup\""
    -DAP_PASSWORD="\"mohn1234\""

    ; ── NVS ──
    -DNVS_NODE="\"mohnnode\""
    -DNVS_GAME="\"mohngame\""
    -DNVS_WIFI="\"wifi\""

    ; ── Timing ──
    -DHEARTBEAT_INTERVAL_MS=300000
    -DWIFI_CONNECT_TIMEOUT_MS=30000
    -DWIFI_RECONNECT_INTERVAL_MS=60000
    -DHTTP_TIMEOUT_MS=15000
    -DNTP_SERVER="\"pool.ntp.org\""

    ; ── Economy ──
    -DREWARD_POINTS_PER_CYCLE=1
    -DDAILY_REWARD_CAP=50
    -DGPS_REWARD_BONUS=5

    ; ── Game ──
    -DENABLE_GAME=1
    -DARENA_TICK_MS=5000
    -DEGG_HATCH_HEARTBEATS=144

    ; ── Device tier/hardware flags are set per [env:*] below.
    ;      Fallback defaults live in src/core/aquarium.h via #ifndef.

; ══════════════════════════════════════════════════
;  TIER 0 — NANO POD: Seeed XIAO ESP32C6
;  No screen. Creature lives blind — phone is the window.
;  RISC-V core, WiFi 6, BLE 5.3 + Zigbee. Ultra-compact.
;  Max Stage: HATCHLING (creature is tiny in this device)
; ══════════════════════════════════════════════════
[env:xiao_c6]
platform = espressif32
board = seeed_xiao_esp32c6

lib_deps =
    ${env.lib_deps}
    h2zero/NimBLE-Arduino@^2.0.0

build_src_filter =
    +<core/>
    +<creature/>
    +<input/>
    +<ble/>
    +<main_unified.cpp>
    -<main.cpp>
    -<config.h>
    -<display/>
    -<ui/>
    -<lora/>

build_flags =
    ${env.build_flags}
    -DBOARD_NAME="\"XIAO ESP32C6\""
    -DAQUARIUM_TIER=0
    -DAQUARIUM_NAME="\"Nano Pod\""
    -DMAX_CREATURE_STAGE=1
    -DMAX_SPRITE_SIZE=0
    -DHAS_BLE=1
    -DLED_PIN=15
    -DBUTTON_PIN=9

; ══════════════════════════════════════════════════
;  TIER 0 — MICRO POD: HiLetgo ESP-32S
;  No screen. Classic ESP32-WROOM-32. Budget node.
;  Has BT Classic for phone provisioning.
;  Max Stage: HATCHLING
; ══════════════════════════════════════════════════
[env:hiletgo]
platform = espressif32
board = esp32dev

lib_deps = ${env.lib_deps}

build_src_filter =
    +<core/>
    +<creature/>
    +<input/>
    +<main_unified.cpp>
    -<main.cpp>
    -<config.h>
    -<display/>
    -<ble/>
    -<ui/>
    -<lora/>

build_flags =
    ${env.build_flags}
    -DBOARD_NAME="\"HiLetgo ESP-32S\""
    -DAQUARIUM_TIER=0
    -DAQUARIUM_NAME="\"Micro Pod\""
    -DMAX_CREATURE_STAGE=1
    -DHAS_BLE=0
    -DLED_PIN=2
    -DBUTTON_PIN=0

; ══════════════════════════════════════════════════
;  TIER 1 — SMALL TANK: Heltec Wireless Tracker
;  80×160 ST7735 TFT + LoRa SX1262 + GPS UC6580
;  Tiny creature view, mining stats, mesh network.
;  Max Stage: JUVENILE (creature is growing)
; ══════════════════════════════════════════════════
[env:tracker]
platform = espressif32
board = heltec_wifi_lora_32_V3

lib_deps =
    ${env.lib_deps}
    bodmer/TFT_eSPI@^2.5.43
    jgromes/RadioLib@^6.6.0
    mikalhart/TinyGPSPlus@^1.1.0

build_src_filter =
    +<core/>
    +<creature/>
    +<display/display_config.h>
    +<display/display_hal.h>
    +<display/display_hal.cpp>
    +<display/creature_renderer.h>
    +<display/creature_renderer.cpp>
    +<display/sprites/>
    +<input/>
    +<ui/>
    +<lora/>
    +<main_unified.cpp>
    -<main.cpp>
    -<config.h>
    -<display/display_main.cpp>
    -<display/mohnster.h>
    -<display/mohnster.cpp>
    -<display/evolution.h>
    -<display/evolution.cpp>
    -<display/sprite_engine.h>
    -<display/sprite_engine.cpp>
    -<display/ui_overlay.h>
    -<display/ui_overlay.cpp>
    -<ble/>

build_flags =
    ${env.build_flags}
    -DBOARD_NAME="\"Wireless Tracker\""
    -DAQUARIUM_TIER=1
    -DAQUARIUM_NAME="\"Small Tank\""
    -DMAX_CREATURE_STAGE=2
    -DMAX_SPRITE_SIZE=24
    -DHAS_DISPLAY=1
    -DDISPLAY_DRIVER=1
    -DSCREEN_W=160
    -DSCREEN_H=80
    -DUSE_SPRITE_BUFFER=0

    ; TFT_eSPI
    -DUSER_SETUP_LOADED=1
    -DST7735_DRIVER=1
    -DTFT_WIDTH=80
    -DTFT_HEIGHT=160
    -DTFT_RGB_ORDER=TFT_BGR
    -DTFT_MOSI=42
    -DTFT_SCLK=41
    -DTFT_CS=38
    -DTFT_DC=40
    -DTFT_RST=39
    -DTFT_BL=21
    -DSPI_FREQUENCY=27000000

    ; LoRa SX1262
    -DHAS_LORA=1
    -DLORA_NSS=8
    -DLORA_DIO1=14
    -DLORA_RST=12
    -DLORA_BUSY=13
    -DLORA_FREQUENCY=915.0
    -DLORA_BANDWIDTH=125.0
    -DLORA_SPREADING_FACTOR=10
    -DLORA_CODING_RATE=5
    -DLORA_SYNC_WORD=0x4D
    -DLORA_TX_POWER=17
    -DLORA_BEACON_INTERVAL_MS=30000

    ; GPS
    -DHAS_GPS=1
    -DGPS_RX_PIN=33
    -DGPS_TX_PIN=34
    -DGPS_BAUD=9600

    -DLED_PIN=18
    -DBUTTON_PIN=0

; ══════════════════════════════════════════════════
;  TIER 2 — WRIST HUD: Heltec Vision Master T190
;  170×320 ST7789 TFT. 8MB PSRAM. Full creature view.
;  ★ THIS IS THE TESTED/WORKING DISPLAY DEVICE ★
;  Full behavior engine, battle system, evolution FX.
;  Max Stage: EVOLVED (creature reaches full potential)
; ══════════════════════════════════════════════════
[env:vmt190]
platform = espressif32
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.psram_type = opi
board_build.arduino.memory_type = qio_opi
upload_speed = 921600

lib_deps =
    ${env.lib_deps}
    adafruit/Adafruit ST7735 and ST7789 Library@^1.10.0
    adafruit/Adafruit GFX Library@^1.11.0
    h2zero/NimBLE-Arduino@^2.0.0

build_src_filter =
    +<core/>
    +<creature/>
    +<display/display_config.h>
    +<display/gfx_compat.h>
    +<display/display_hal.h>
    +<display/display_hal.cpp>
    +<display/creature_renderer.h>
    +<display/creature_renderer.cpp>
    +<display/screen_manager.h>
    +<display/screen_manager.cpp>
    +<display/stats_screen.h>
    +<display/stats_screen.cpp>
    +<display/mining_screen.h>
    +<display/mining_screen.cpp>
    +<display/system_screen.h>
    +<display/system_screen.cpp>
    +<display/sprites/>
    +<input/>
    +<ble/>
    +<ui/>
    +<main_unified.cpp>
    -<main.cpp>
    -<config.h>
    -<display/display_main.cpp>
    -<display/mohnster.h>
    -<display/mohnster.cpp>
    -<display/evolution.h>
    -<display/evolution.cpp>
    -<display/sprite_engine.h>
    -<display/sprite_engine.cpp>
    -<display/ui_overlay.h>
    -<display/ui_overlay.cpp>
    -<lora/>

build_flags =
    ${env.build_flags}
    -DBOARD_NAME="\"Vision Master T190\""
    -DAQUARIUM_TIER=2
    -DAQUARIUM_NAME="\"Wrist HUD\""
    -DMAX_CREATURE_STAGE=4
    -DMAX_SPRITE_SIZE=64
    -DHAS_DISPLAY=1
    -DDISPLAY_DRIVER=2
    -DSCREEN_W=320
    -DSCREEN_H=170
    -DHAS_PSRAM=1
    -DUSE_SPRITE_BUFFER=1

    ; Adafruit ST7789 (Vision Master T190 tested pinout)
    ; SPI pins handled in display_hal.cpp init code
    -DTFT_BL=17
    -DBOARD_HAS_PSRAM=1
    -DCONFIG_SPIRAM_SUPPORT=1
    -DARDUINO_USB_CDC_ON_BOOT=1

    ; Hardware
    -DHAS_LORA=0
    -DHAS_GPS=0
    -DHAS_BLE=1
    -DLED_PIN=18
    -DBUTTON_PIN=0
    -DBUTTON2_PIN=21
    -DBATTERY_ADC_PIN=6
    -DBATTERY_ADC_CTRL=46
    -DVEXT_PIN=5
    -DPWR_PIN=7

    ; ── MohnMatrix Node Worker ──
    ; Makes this device a MohnMatrix network node while
    ; running the MohnSters game (proof-of-service)
    -DENABLE_MATRIX_NODE=1
    -DMATRIX_API_URL="\"https://mohnmatrix.com\""
    -DMATRIX_HEARTBEAT_INTERVAL_MS=30000

; ══════════════════════════════════════════════════
;  SECURE BOOT / FLASH ENCRYPTION CONFIG
;  These settings prepare for production secure boot.
;  In development, keys are NOT enforced — set
;  -DENABLE_SECURE_BOOT=1 to compile with secure
;  NVS encryption for wallet key storage.
;
;  To sign firmware for OTA delivery:
;    espsecure.py sign_data --version 2
;      --keyfile keys/secure_boot_signing_key.pem
;      firmware.bin
;
;  Wallet private keys are stored in the encrypted
;  NVS partition and tied to the creature DNA via
;  HKDF-SHA256 key derivation on the desktop.
;  The device stores only the public key + wallet
;  address for proof-of-presence verification.
; ══════════════════════════════════════════════════
; [env:vmt190_secure]
; extends = env:vmt190
; board_build.partitions = custom_secure_16MB.csv
; build_flags =
;     ${env:vmt190.build_flags}
;     -DENABLE_SECURE_BOOT=1
;     -DENABLE_NVS_ENCRYPTION=1
;     -DWALLET_KEY_NVS_NS="\"mohnwallet\""
;     -DWALLET_ADDRESS_NVS_KEY="\"addr\""
;     -DWALLET_PUBKEY_NVS_KEY="\"pubkey\""
;     -DDEVICE_PROOF_NVS_KEY="\"devproof\""

; ══════════════════════════════════════════════════
;  VMT190 Display Test — minimal firmware to verify
;  TFT hardware is working
; ══════════════════════════════════════════════════
[env:vmt190_test]
platform = espressif32
board = esp32-s3-devkitc-1
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.psram_type = opi
board_build.arduino.memory_type = qio_opi
upload_speed = 921600

lib_deps =
    adafruit/Adafruit ST7735 and ST7789 Library@^1.10.0
    adafruit/Adafruit GFX Library@^1.11.0

build_src_filter =
    +<test_display.cpp>

build_flags =
    -DVMT190_DISPLAY_TEST=1
    -DBOARD_HAS_PSRAM=1
    -DARDUINO_USB_CDC_ON_BOOT=1

